# OpenAPI-Serve

This is a barebone API server designed to perform routing and validation
for API services that are described by an OpenAPI document.

## Features

### Routing

All incoming requests are routed to the operation specified by an
OpenAPI document. Example:

```yaml
paths:
  /example:
    get:
      operationId: examples/Get
```

Will cause any request to `/example` to be routed to the `examples/Get`
handler. The handler is resolved by mapping the `examples/Get` operationId
to a relative path, such as `./operations/examples/Get.js`.

### Model Binding

The server performs model binding for the request body and path parameters
according to the schema described in the OpenAPI document.

For instance, consider this OpenAPI document:

```yaml
paths:
  /example/{id}:
    post:
      operationId: examples/Post
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
```

The handler function will be called with a `pathParameters` object containing
the `id` parameter, and a `requestBody` object containing the `name` property.
Both objects will be strongly typed with full intellisense support:

```ts
import type { IApiHandler } from '@altearius/openapi-serve';
import type { operations } from './openapi.yaml';
type Handler = IApiHandler<operations, 'archive/snapshot/Get'>;

const Get: Handler = async ({
  pathParameters: { id },
  requestBody: { name }
}) => {
  return {
    body: { result: await CreateExample(id, name) },
    statusCode: StatusCodes.Created
  };
};

export default Get;
```

### Model Validation

The server validates the request body and path parameters according to the
schema described in the OpenAPI document. This is done using the Ajv
validation library. Invalid models will result in a 400 Bad Request response,
skipping the handler function entirely.

## Installation

```bash
yarn add @altearius/openapi-serve
```

## Usage

```ts
import { OpenApiServer } from 'openapi-serve';

const Server = await OpenApiServer.Create({
  openApiPath: './openapi.yaml',
  operationRootPath: './operations'
});

process.on('SIGINT', async () => {
  await Server.closeAsync();
  process.exit(0);
});

const port = 3001;
await Server.listenAsync(port, '0.0.0.0');
```

## Configuration

The `OpenApiServe` constructor accepts a configuration object with these
properties:

- `allowedOrigins`: An array of regular expressions that specify which origins
  are allowed to make CORS requests. If not specified, CORS is enabled only for
  localhost.

- `log`: A [pino logger][1] object.

- `openApiPath`: The path to the OpenAPI document.

- `operationRootPath`: The path to the directory containing the handler
  functions.

- `staticRoutes`: A `Map<RegExp, string>` of addiontal static routes to serve.
  The regular expression may contain a named capture groupd named `relative`,
  which will be used to construct the file path to serve, enabling support
  for dynamic routes.

- `validations`: Stand-alone validation code generated by Ajv.

## Handler Functions

Handler functions are called with a single `content` parameter, following
this format:

```ts
interface Content {
  message: IncomingMessage;
  pathParameters?: object;
  requestBody?: object;
  url: URL;
}
```

The `pathParameters` and `requestBody` properties are the result of
validating the request against the OpenAPI schema.

## TypeScript

An `IApiHandler` type is provided to provide strong typing for the handler
function, including the request and response types:

```ts
import type { operations } from './openapi.yaml';
import type { IApiHandler } from 'openapi-serve';

const Handler: IApiHandler<operations, 'examples/Get'> = async ({
  pathParameters: { detail }
}) => {
  // detail is strongly typed according to the schema described in the OpenAPI
  // document.
  const body = { detail: await GetExampleDetail(detail) };

  // The return type of `body` is type-checked according to the OpenAPI schema.
  return { body, statusCode: StatusCodes.OK };
};

export default Handler;
```

This depends on generating type definitions for the `openapi.yaml` file.
These definitions should be generated by a tool using the
[openapi-typescript][2] package, such as the sister project,
`openapi-type-gen`.

## TODO:

Authentication / Authorization.

[1]: https://www.npmjs.com/package/pino 'Pino'
[2]: https://www.npmjs.com/package/openapi-typescript 'OpenAPI TypeScript'
[3]: https://ajv.js.org/ 'Ajv'
