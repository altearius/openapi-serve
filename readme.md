# OpenAPI-Serve

This is a barebone API server designed to perform routing and validation
for API services that are described by an OpenAPI document.

The server is responsible for these tasks:

- Routing a request to the appropriate handler, as specified by an OpenAPI
  document.

- Performing basic model binding and type coercion for path parameters.

- Validating the request body and path parameters according to the schema
  provided by the OpenAPI document.

- Manging CORS headers.

- Providing a Swagger UI for the OpenAPI document.

## Installation

```bash
yarn add @altearius/openapi-serve
```

## Usage

```ts
import { OpenApiServer } from 'openapi-serve';

const Server = await OpenApiServer.Create({
  openApiPath: './openapi.yaml',
  operationRootPath: './operations'
});

process.on('SIGINT', async () => {
  await Server.closeAsync();
  process.exit(0);
});

const port = 3001;
await Server.listenAsync(port, '0.0.0.0');
```

## Configuration

The `OpenApiServe` constructor accepts a configuration object with these
properties:

- `allowedOrigins`: An array of regular expressions that specify which origins
  are allowed to make CORS requests. If not specified, CORS is enabled only for
  localhost.

- `log`: A [pino logger][1] object.

- `openApiPath`: The path to the OpenAPI document.

- `operationRootPath`: The path to the directory containing the handler
  functions.

- `staticRoutes`: A `Map<RegExp, string>` of addiontal static routes to serve.
  The regular expression may contain a named capture groupd named `relative`,
  which will be used to construct the file path to serve, enabling support
  for dynamic routes.

- `validations`: Stand-alone validation code generated by Ajv.

## OpenAPI Document

The server performs routing by comparing each incoming request against the
methods and paths specified in the OpenAPI document. When a match is found,
the OpenAPI `operationId` is used to locate the handler function.

For instance, this OpenAPI document fragment:

```yaml
/examples/{detail}:
  get:
    description: Get details about an example
    operationId: examples/Get
    parameters: [$ref: '#/components/parameters/detail']
    responses:
      '200':
        description: The details.
        content:
          application/json:
            schema:
              type: object
```

Would by handled by a function located at `./operations/examples/Get.ts`:

```ts
export default async function ({ pathParameters: { detail } }) {
  return {
    body: { result: await GetExampleDetail(detail) },
    statusCode: StatusCodes.OK
  };
}
```

The handler function must be the default export.

## Handler Functions

Handler functions are called with a single `content` parameter, following
this format:

```ts
interface Content {
  message: IncomingMessage;
  pathParameters?: object;
  requestBody?: object;
  url: URL;
}
```

The `pathParameters` and `requestBody` properties are the result of
validating the request against the OpenAPI schema.

## TypeScript

An `IApiHandler` type is provided to provide strong typing for the handler
function, including the request and response types:

```ts
import type { operations } from './openapi.yaml';
import type { IApiHandler } from 'openapi-serve';

const Handler: IApiHandler<operations, 'examples/Get'> = async ({
  pathParameters: { detail }
}) => {
  // detail is strongly typed according to the schema described in the OpenAPI
  // document.
  const body = { detail: await GetExampleDetail(detail) };

  // The return type of `body` is type-checked according to the OpenAPI schema.
  return { body, statusCode: StatusCodes.OK };
};

export default Handler;
```

This depends on generating type definitions for the `openapi.yaml` file.
These definitions should be generated by a tool using the
[openapi-typescript][2] package, such as the sister project,
`openapi-type-gen`.

## TODO:

Authentication / Authorization.

[1]: https://www.npmjs.com/package/pino 'Pino'
[2]: https://www.npmjs.com/package/openapi-typescript 'OpenAPI TypeScript'
